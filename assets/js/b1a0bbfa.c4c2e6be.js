"use strict";(self.webpackChunkcloud=self.webpackChunkcloud||[]).push([[2164],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>m});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),u=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=u(e.components);return a.createElement(l.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},c=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),c=u(t),m=r,b=c["".concat(l,".").concat(m)]||c[m]||d[m]||i;return t?a.createElement(b,o(o({ref:n},p),{},{components:t})):a.createElement(b,o({ref:n},p))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,o=new Array(i);o[0]=c;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var u=2;u<i;u++)o[u]=t[u];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}c.displayName="MDXCreateElement"},7999:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>u});var a=t(7462),r=(t(7294),t(3905));const i={},o="minikube",s={unversionedId:"minikube",id:"minikube",title:"minikube",description:"My minikube environment",source:"@site/docs/minikube.md",sourceDirName:".",slug:"/minikube",permalink:"/cloud/docs/minikube",draft:!1,editUrl:"https://github.com/facebook/docusaurus/edit/main/website/docs/minikube.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Linux",permalink:"/cloud/docs/linux"},next:{title:"Openshift",permalink:"/cloud/docs/oc"}},l={},u=[{value:"My minikube environment",id:"my-minikube-environment",level:2},{value:"Operations",id:"operations",level:2},{value:"Connect to minikube VM host",id:"connect-to-minikube-vm-host",level:3},{value:"start minikube",id:"start-minikube",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Creating VM error",id:"creating-vm-error",level:3},{value:"Error",id:"error",level:4},{value:"Resolution",id:"resolution",level:4},{value:"bad certificate",id:"bad-certificate",level:3},{value:"Error",id:"error-1",level:4},{value:"Resolution",id:"resolution-1",level:4},{value:"Commands reference",id:"commands-reference",level:2},{value:"System Outlook",id:"system-outlook",level:2},{value:"Reference",id:"reference",level:2},{value:"Lab",id:"lab",level:2},{value:"Lab 02 Operating containers",id:"lab-02-operating-containers",level:3},{value:"Lab 04 Running an Application",id:"lab-04-running-an-application",level:3},{value:"Lab 05 Managing application",id:"lab-05-managing-application",level:3},{value:"Labels",id:"labels",level:4},{value:"Running an application",id:"running-an-application",level:4},{value:"namespace",id:"namespace",level:4},{value:"num of replicas",id:"num-of-replicas",level:4},{value:"Managing application updates and rollbacks",id:"managing-application-updates-and-rollbacks",level:4}],p={toc:u};function d(e){let{components:n,...t}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"minikube"},"minikube"),(0,r.kt)("h2",{id:"my-minikube-environment"},"My minikube environment"),(0,r.kt)("p",null,"On an old Windows thinkpad laptop with 24 GB memory, ",(0,r.kt)("inlineCode",{parentName:"p"},"Fedora")," VMware VM.",(0,r.kt)("br",{parentName:"p"}),"\n","Starting ",(0,r.kt)("inlineCode",{parentName:"p"},"minikube")," by ",(0,r.kt)("inlineCode",{parentName:"p"},"KVM")," on the Fedora VM.     "),(0,r.kt)("h2",{id:"operations"},"Operations"),(0,r.kt)("h3",{id:"connect-to-minikube-vm-host"},"Connect to minikube VM host"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"ssh junsulee@fedora # login to fedora VM\nsudo su -  # for operations needing root permission\n")),(0,r.kt)("h3",{id:"start-minikube"},"start minikube"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Give KVM authority to users. give ",(0,r.kt)("inlineCode",{parentName:"li"},"libvirt")," group to users.",(0,r.kt)("br",{parentName:"li"}),"Necessary to start ",(0,r.kt)("inlineCode",{parentName:"li"},"minikube")," ")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[root@fedora kubernetes]# usermod -aG libvirt junsulee\n[root@fedora kubernetes]# usermod -aG libvirt student\n[root@fedora ~]# grep vmx /proc/cpuinfo    ## should have `vmx` \n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Start by a non root user      ")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"minikube start --memory 4096 --vm-driver=kvm2\n")),(0,r.kt)("p",null,"example :  "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'[junsulee@fedora ~]$ minikube start --memory 4096 --vm-driver=kvm2\n* minikube v1.20.0 on Fedora 34\n* Using the kvm2 driver based on user configuration\n* Starting control plane node minikube in cluster minikube\n* Creating kvm2 VM (CPUs=2, Memory=4096MB, Disk=20000MB) ...\n* Preparing Kubernetes v1.20.2 on Docker 20.10.6 ...\n  - Generating certificates and keys ...\n  - Booting up control plane ...\n  - Configuring RBAC rules ...\n* Verifying Kubernetes components...\n  - Using image gcr.io/k8s-minikube/storage-provisioner:v5\n* Enabled addons: default-storageclass, storage-provisioner\n* Done! kubectl is now configured to use "minikube" cluster and "default" namespace by default\n')),(0,r.kt)("p",null,"When starting after system halt    "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'[junsulee@fedora ~]$ minikube start --memory 4096 --vm-driver=kvm2\n* minikube v1.20.0 on Fedora 34\n* minikube 1.22.0 is available! Download it: https://github.com/kubernetes/minikube/releases/tag/v1.22.0\n* To disable this notice, run: \'minikube config set WantUpdateNotification false\'\n\n* Using the kvm2 driver based on existing profile\n* Starting control plane node minikube in cluster minikube\n* Restarting existing kvm2 VM for "minikube" ...\n* Preparing Kubernetes v1.20.2 on Docker 20.10.6 ...\nX Problems detected in kubelet:\n  Aug 29 23:38:41 minikube kubelet[2691]: E0829 23:38:41.239851    2691 pod_workers.go:191] Error syncing pod b320587ee357c92247809ba00ce3080a ("kube-apiserver-minikube_kube-system(b320587ee357c92247809ba00ce3080a)"), skipping: failed to "StartContainer" for "kube-apiserver" with CrashLoopBackOff: "back-off 20s restarting failed container=kube-apiserver pod=kube-apiserver-minikube_kube-system(b320587ee357c92247809ba00ce3080a)"\nX Problems detected in kubelet:\n  Aug 29 23:38:41 minikube kubelet[2691]: E0829 23:38:41.239851    2691 pod_workers.go:191] Error syncing pod b320587ee357c92247809ba00ce3080a ("kube-apiserver-minikube_kube-system(b320587ee357c92247809ba00ce3080a)"), skipping: failed to "StartContainer" for "kube-apiserver" with CrashLoopBackOff: "back-off 20s restarting failed container=kube-apiserver pod=kube-apiserver-minikube_kube-system(b320587ee357c92247809ba00ce3080a)"\n  Aug 29 23:38:50 minikube kubelet[2691]: E0829 23:38:50.122463    2691 pod_workers.go:191] Error syncing pod b320587ee357c92247809ba00ce3080a ("kube-apiserver-minikube_kube-system(b320587ee357c92247809ba00ce3080a)"), skipping: failed to "StartContainer" for "kube-apiserver" with CrashLoopBackOff: "back-off 20s restarting failed container=kube-apiserver pod=kube-apiserver-minikube_kube-system(b320587ee357c92247809ba00ce3080a)"\n  Aug 29 23:38:51 minikube kubelet[2691]: E0829 23:38:51.165528    2691 pod_workers.go:191] Error syncing pod 474c55dfb64741cc485e46b6bb9f2dc0 ("kube-controller-manager-minikube_kube-system(474c55dfb64741cc485e46b6bb9f2dc0)"), skipping: failed to "StartContainer" for "kube-controller-manager" with CrashLoopBackOff: "back-off 20s restarting failed container=kube-controller-manager pod=kube-controller-manager-minikube_kube-system(474c55dfb64741cc485e46b6bb9f2dc0)"\n  Aug 29 23:38:54 minikube kubelet[2691]: E0829 23:38:54.439750    2691 pod_workers.go:191] Error syncing pod 474c55dfb64741cc485e46b6bb9f2dc0 ("kube-controller-manager-minikube_kube-system(474c55dfb64741cc485e46b6bb9f2dc0)"), skipping: failed to "StartContainer" for "kube-controller-manager" with CrashLoopBackOff: "back-off 20s restarting failed container=kube-controller-manager pod=kube-controller-manager-minikube_kube-system(474c55dfb64741cc485e46b6bb9f2dc0)"\n! Unable to restart cluster, will reset it: apiserver health: apiserver healthz never reported healthy: cluster wait timed out during healthz check\n  - Generating certificates and keys ...\n  - Booting up control plane ...\n  - Configuring RBAC rules ...\n* Verifying Kubernetes components...\n  - Using image gcr.io/k8s-minikube/storage-provisioner:v5\n* Enabled addons: default-storageclass, storage-provisioner\n* Done! kubectl is now configured to use "minikube" cluster and "default" namespace by default\n')),(0,r.kt)("h2",{id:"troubleshooting"},"Troubleshooting"),(0,r.kt)("h3",{id:"creating-vm-error"},"Creating VM error"),(0,r.kt)("h4",{id:"error"},"Error"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"! StartHost failed, but will try again: creating host: create: Error creating machine: Error in driver during machine creation: error creating VM: virError(Code=1, Domain=10, Message='internal error: process exited while connecting to monitor: 2021-05-17T07:32:21.253962Z qemu-system-x86_64: error: failed to set MSR 0x48f to 0x7fffff00036dfb\nqemu-system-x86_64: ../target/i386/kvm.c:2701: kvm_buf_set_msrs: Assertion `ret == cpu->kvm_msr_buf->nmsrs' failed.')\n* Creating kvm2 VM (CPUs=2, Memory=4096MB, Disk=20000MB) ...\n")),(0,r.kt)("h4",{id:"resolution"},"Resolution"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/minikube/issues/2968"},"https://github.com/kubernetes/minikube/issues/2968"),"\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/minikube/issues/2412"},"https://github.com/kubernetes/minikube/issues/2412")),(0,r.kt)("p",null,"On vmware configuration, turn on 'Virtualize CPU performance counters'.     "),(0,r.kt)("h3",{id:"bad-certificate"},(0,r.kt)("a",{parentName:"h3",href:"https://stackoverflow.com/questions/71542604/minikube-remote-error-tls-bad-certificate"},"bad certificate")),(0,r.kt)("h4",{id:"error-1"},"Error"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'[junsulee@fedora ~]$ minikube_start\n\ud83d\ude04  minikube v1.20.0 on Fedora 34\n\u2728  Using the kvm2 driver based on existing profile\n\ud83d\udc4d  Starting control plane node minikube in cluster minikube\n\ud83d\udd04  Restarting existing kvm2 VM for "minikube" ...\n\ud83d\udc33  Preparing Kubernetes v1.20.2 on Docker 20.10.6 ...\n\u274c  Problems detected in etcd [4e630926db47]:\n    2022-05-21 04:49:16.015098 I | embed: rejected connection from "127.0.0.1:53760" (error "remote error: tls: bad certificate", ServerName "")\n    2022-05-21 04:49:19.119305 I | embed: rejected connection from "127.0.0.1:53766" (error "remote error: tls: bad certificate", ServerName "")\n    2022-05-21 04:49:20.231942 I | embed: rejected connection from "127.0.0.1:53774" (error "remote error: tls: bad certificate", ServerName "")\n')),(0,r.kt)("h4",{id:"resolution-1"},"Resolution"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubectl conf view\nkubectl config delete-cluster minikube\nminikube delete\nminikube_start\n")),(0,r.kt)("h2",{id:"commands-reference"},"Commands reference"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"minikube dashboard   ## works in fedora GUI. Opening web browser\n")),(0,r.kt)("h2",{id:"system-outlook"},"System Outlook"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[junsulee@fedora kube]$ kubectl get all\nNAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE\nservice/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   17\n\n$ kubectl get nodes\nNAME       STATUS   ROLES                  AGE   VERSION\nminikube   Ready    control-plane,master   6d    v1.20.2\n\n$ kubectl cluster-info\nKubernetes control plane is running at https://192.168.39.235:8443\nKubeDNS is running at https://192.168.39.235:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy\n\nTo further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.\n\n[junsulee@fedora ~]$ kubectl config view\napiVersion: v1\nclusters:\n- cluster:\n    certificate-authority: /home/junsulee/.minikube/ca.crt\n    extensions:\n    - extension:\n        last-update: Sat, 14 May 2022 13:01:44 AEST\n        provider: minikube.sigs.k8s.io\n        version: v1.20.0\n      name: cluster_info\n    server: https://192.168.39.235:8443\n  name: minikube\ncontexts:\n- context:\n    cluster: minikube\n    extensions:\n    - extension:\n        last-update: Sat, 14 May 2022 13:01:44 AEST\n        provider: minikube.sigs.k8s.io\n        version: v1.20.0\n      name: context_info\n    namespace: default\n    user: minikube\n  name: minikube\ncurrent-context: minikube\nkind: Config\npreferences: {}\nusers:\n- name: minikube\n  user:\n    client-certificate: /home/junsulee/.minikube/profiles/minikube/client.crt\n    client-key: /home/junsulee/.minikube/profiles/minikube/client.key\n")),(0,r.kt)("h2",{id:"reference"},"Reference"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/sandervanvugt/kubernetes"},"Oreilly kubernetes education github repository")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://borysneselovskyi.wordpress.com/2018/02/19/kvm-virtualization-on-top-of-the-vmware-workstation-12-guest-vms/"},"KVM Virtualization on VMware 12")),(0,r.kt)("h2",{id:"lab"},"Lab"),(0,r.kt)("h3",{id:"lab-02-operating-containers"},"Lab 02 Operating containers"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[junsulee@fedora kube]$ docker run --rm -v /dev/log:/dev/log fedora:latest logger \"Message from the container\" \nUnable to find image 'fedora:latest' locally\nlatest: Pulling from library/fedora\n70fb9965a23f: Pull complete \nDigest: sha256:0c18a515203b836ea840f7033a11d6833f9468fda6a99f5a29695cfbaf43f24a\nStatus: Downloaded newer image for fedora:latest\n\n[junsulee@fedora kube]$ journalctl |grep container\n...\nOct 03 20:40:39 fedora root[52426]: Message from the container\n")),(0,r.kt)("h3",{id:"lab-04-running-an-application"},"Lab 04 Running an Application"),(0,r.kt)("p",null,"To start from scratch, deploy existing deployment and pod"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'[junsulee@fedora ~]$ kubectl get deployment\nNAME        READY   UP-TO-DATE   AVAILABLE   AGE\ncmd-nginx   1/1     1            1           32d\n\n[junsulee@fedora ~]$ kubectl get pod\nNAME                         READY   STATUS    RESTARTS   AGE\ncmd-nginx-57bb5f6747-tv4sb   1/1     Running   0          31s\n\n# at this time, the pod runs again because of deployment.   \n# to clear, need to delete deployment together.   \n\n[junsulee@fedora ~]$ kubectl delete deployment cmd-nginx\ndeployment.apps "cmd-nginx" deleted\n\n[junsulee@fedora ~]$ kubectl get deployment\nNo resources found in default namespace.\n\n[junsulee@fedora ~]$ kubectl get pod\nNAME                         READY   STATUS        RESTARTS   AGE\ncmd-nginx-57bb5f6747-tv4sb   0/1     Terminating   0          6m58s\n[junsulee@fedora ~]$ kubectl delete pod cmd-nginx-57bb5f6747-tv4sb\npod "cmd-nginx-57bb5f6747-tv4sb" deleted\n[junsulee@fedora ~]$ kubectl get pod\nNo resources found in default namespace.\n')),(0,r.kt)("p",null,"create a example pod again "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[junsulee@fedora ~]$ kubectl create deployment cmd-nginx --image=nginx\ndeployment.apps/cmd-nginx created\n[junsulee@fedora ~]$ kubectl get deployment\nNAME        READY   UP-TO-DATE   AVAILABLE   AGE\ncmd-nginx   0/1     1            0           8s\n[junsulee@fedora ~]$ kubectl get pod\nNAME                         READY   STATUS    RESTARTS   AGE\ncmd-nginx-57bb5f6747-bgqz4   1/1     Running   0          15s\n\n[junsulee@fedora work]$ kubectl get deployment.apps\nNAME        READY   UP-TO-DATE   AVAILABLE   AGE\ncmd-nginx   1/1     1            1           18h\n\n")),(0,r.kt)("p",null,"Create yaml referring existing apps."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'[junsulee@fedora work]$ kubectl get deployment.apps -o yaml > myngnix.yaml\n\n[junsulee@fedora work]$ cat myngnix.yaml\napiVersion: v1\nitems:\n- apiVersion: apps/v1\n  kind: Deployment\n  metadata:\n    annotations:\n      deployment.kubernetes.io/revision: "1"\n    creationTimestamp: "2022-06-24T05:14:35Z"\n    generation: 1\n    labels:\n      app: cmd-nginx\n    name: cmd-nginx\n    namespace: default\n    resourceVersion: "1619298"\n    uid: ab2c24aa-c432-42b0-ad9a-7340019c1c5c\n  spec:\n    progressDeadlineSeconds: 600\n    replicas: 1\n    revisionHistoryLimit: 10\n    selector:\n      matchLabels:\n        app: cmd-nginx\n    strategy:\n      rollingUpdate:\n        maxSurge: 25%\n        maxUnavailable: 25%\n      type: RollingUpdate\n    template:\n      metadata:\n        creationTimestamp: null\n        labels:\n          app: cmd-nginx\n      spec:\n        containers:\n        - image: nginx\n          imagePullPolicy: Always\n          name: nginx\n          resources: {}\n          terminationMessagePath: /dev/termination-log\n          terminationMessagePolicy: File\n        dnsPolicy: ClusterFirst\n        restartPolicy: Always\n        schedulerName: default-scheduler\n        securityContext: {}\n        terminationGracePeriodSeconds: 30\n  status:\n    availableReplicas: 1\n    conditions:\n    - lastTransitionTime: "2022-06-24T05:14:48Z"\n      lastUpdateTime: "2022-06-24T05:14:48Z"\n      message: Deployment has minimum availability.\n      reason: MinimumReplicasAvailable\n      status: "True"\n      type: Available\n    - lastTransitionTime: "2022-06-24T05:14:35Z"\n      lastUpdateTime: "2022-06-24T05:14:48Z"\n      message: ReplicaSet "cmd-nginx-57bb5f6747" has successfully progressed.\n      reason: NewReplicaSetAvailable\n      status: "True"\n      type: Progressing\n    observedGeneration: 1\n    readyReplicas: 1\n    replicas: 1\n    updatedReplicas: 1\nkind: List\nmetadata:\n  resourceVersion: ""\n  selfLink: ""\n\n')),(0,r.kt)("p",null,"Remove unnecessary parts.  "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'[junsulee@fedora work]$ cp myngnix.yaml myngnix_org.yaml\n\n[junsulee@fedora work]$ cat myngnix.yaml\napiVersion: v1\nitems:\n- apiVersion: apps/v1\n  kind: Deployment\n  metadata:\n    annotations:\n      deployment.kubernetes.io/revision: "1"\n    generation: 1\n    labels:\n      app: cmd-nginx\n    name: cmd-nginx\n    namespace: default\n  spec:\n    progressDeadlineSeconds: 600\n    replicas: 1\n    revisionHistoryLimit: 10\n    selector:\n      matchLabels:\n        app: cmd-nginx\n    strategy:\n      rollingUpdate:\n        maxSurge: 25%\n        maxUnavailable: 25%\n      type: RollingUpdate\n    template:\n      metadata:\n        creationTimestamp: null\n        labels:\n          app: cmd-nginx\n      spec:\n        containers:\n        - image: nginx\n          imagePullPolicy: Always\n          name: nginx\n          resources: {}\n          terminationMessagePath: /dev/termination-log\n          terminationMessagePolicy: File\n        dnsPolicy: ClusterFirst\n        restartPolicy: Always\n        schedulerName: default-scheduler\n        securityContext: {}\n        terminationGracePeriodSeconds: 30\n[junsulee@fedora work]$\n[junsulee@fedora work]$ diff myngnix_org.yaml myngnix.yaml\n8d7\n<     creationTimestamp: "2022-06-24T05:14:35Z"\n14,15d12\n<     resourceVersion: "1619298"\n<     uid: ab2c24aa-c432-42b0-ad9a-7340019c1c5c\n46,68d42\n<   status:\n<     availableReplicas: 1\n<     conditions:\n<     - lastTransitionTime: "2022-06-24T05:14:48Z"\n<       lastUpdateTime: "2022-06-24T05:14:48Z"\n<       message: Deployment has minimum availability.\n<       reason: MinimumReplicasAvailable\n<       status: "True"\n<       type: Available\n<     - lastTransitionTime: "2022-06-24T05:14:35Z"\n<       lastUpdateTime: "2022-06-24T05:14:48Z"\n<       message: ReplicaSet "cmd-nginx-57bb5f6747" has successfully progressed.\n<       reason: NewReplicaSetAvailable\n<       status: "True"\n<       type: Progressing\n<     observedGeneration: 1\n<     readyReplicas: 1\n<     replicas: 1\n<     updatedReplicas: 1\n< kind: List\n< metadata:\n<   resourceVersion: ""\n<   selfLink: ""\n\n')),(0,r.kt)("h3",{id:"lab-05-managing-application"},"Lab 05 Managing application"),(0,r.kt)("h4",{id:"labels"},"Labels"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[junsulee@fedora work]$ kubectl get all --show-labels\nNAME                             READY   STATUS    RESTARTS   AGE   LABELS\npod/cmd-nginx-57bb5f6747-bgqz4   1/1     Running   0          20h   app=cmd-nginx,pod-template-hash=57bb5f6747\n\nNAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE   LABELS\nservice/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   34d   component=apiserver,provider=kubernetes\n\nNAME                        READY   UP-TO-DATE   AVAILABLE   AGE   LABELS\ndeployment.apps/cmd-nginx   1/1     1            1           20h   app=cmd-nginx\n\nNAME                                   DESIRED   CURRENT   READY   AGE   LABELS\nreplicaset.apps/cmd-nginx-57bb5f6747   1         1         1       20h   app=cmd-nginx,pod-template-hash=57bb5f6747\n[junsulee@fedora work]$ kubectl label pods ^C\n[junsulee@fedora work]$ kubectl get pods\nNAME                         READY   STATUS    RESTARTS   AGE\ncmd-nginx-57bb5f6747-bgqz4   1/1     Running   0          20h\n")),(0,r.kt)("p",null,"Set Label"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[junsulee@fedora work]$ kubectl label pods cmd-nginx-57bb5f6747-bgqz4 app-\npod/cmd-nginx-57bb5f6747-bgqz4 labeled\n[junsulee@fedora work]$ kubectl get all --show-labels\nNAME                             READY   STATUS    RESTARTS   AGE   LABELS\npod/cmd-nginx-57bb5f6747-6clxd   1/1     Running   0          44s   app=cmd-nginx,pod-template-hash=57bb5f6747\npod/cmd-nginx-57bb5f6747-bgqz4   1/1     Running   0          20h   pod-template-hash=57bb5f6747\n\nNAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE   LABELS\nservice/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   34d   component=apiserver,provider=kubernetes\n\nNAME                        READY   UP-TO-DATE   AVAILABLE   AGE   LABELS\ndeployment.apps/cmd-nginx   1/1     1            1           20h   app=cmd-nginx\n\nNAME                                   DESIRED   CURRENT   READY   AGE   LABELS\nreplicaset.apps/cmd-nginx-57bb5f6747   1         1         1       20h   app=cmd-nginx,pod-template-hash=57bb5f6747\n")),(0,r.kt)("p",null,"It removed ",(0,r.kt)("inlineCode",{parentName:"p"},"app-")," from existing pod label, then created new pod with the existing name",(0,r.kt)("br",{parentName:"p"}),"\n","because k8s monitors the label and make sure specific amount of the label is available.",(0,r.kt)("br",{parentName:"p"}),"\n","It means k8s does not look at the pod itself but looking at the ",(0,r.kt)("inlineCode",{parentName:"p"},"label"),".      "),(0,r.kt)("h4",{id:"running-an-application"},"Running an application"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"Pod")," specification from ",(0,r.kt)("inlineCode",{parentName:"p"},"template"),".    "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"[junsulee@fedora kubernetes]$ cat redis-deploy.yaml\n---\napiVersion: apps/v1beta1\nkind: Deployment\nmetadata:\n  name: redis\n  labels:\n    app: redis\nspec:\n  selector:\n    matchLabels:\n      app: redis\n  replicas:\n  template:\n    metadata:\n      labels:\n        app: redis\n    spec:\n      containers:\n      - name: redis\n        image: redis:alpine\n        ports:\n        - containerPort: 6379\n          name: redis\n")),(0,r.kt)("p",null,"Error due to wrong version.     "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'[junsulee@fedora kubernetes]$ kubectl create -f redis-deploy.yaml\nerror: unable to recognize "redis-deploy.yaml": no matches for kind "Deployment" in version "apps/v1beta\n')),(0,r.kt)("p",null,"Correcting and creating again.",(0,r.kt)("br",{parentName:"p"}),"\n",(0,r.kt)("inlineCode",{parentName:"p"},"apiVersion: apps/v1beta1"),"  =>  ",(0,r.kt)("inlineCode",{parentName:"p"},"apiVersion: apps/v1"),"     "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[junsulee@fedora kubernetes]$ kubectl create -f redis-deploy.yaml\ndeployment.apps/redis created\n[junsulee@fedora kubernetes]$ kubectl get deployment\nNAME        READY   UP-TO-DATE   AVAILABLE   AGE\ncmd-nginx   1/1     1            1           20h\nredis       0/1     1            0           9s     <====\n[junsulee@fedora kubernetes]$ kubectl get pods\nNAME                         READY   STATUS              RESTARTS   AGE\ncmd-nginx-57bb5f6747-6clxd   1/1     Running             0          39m\ncmd-nginx-57bb5f6747-bgqz4   1/1     Running             0          20h\nredis-6fb5b985bc-6q7fk       0/1     ContainerCreating   0          16s  <=====  \n\n[junsulee@fedora kubernetes]$ kubectl get deployment --show-labels\nNAME        READY   UP-TO-DATE   AVAILABLE   AGE    LABELS\ncmd-nginx   1/1     1            1           20h    app=cmd-nginx\nredis       1/1     1            1           2m8s   app=redis\n[junsulee@fedora kubernetes]$ kubectl get all --selector app=redis\nNAME                         READY   STATUS    RESTARTS   AGE\npod/redis-6fb5b985bc-6q7fk   1/1     Running   0          2m21s\n\nNAME                    READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/redis   1/1     1            1           2m21s\n\nNAME                               DESIRED   CURRENT   READY   AGE\nreplicaset.apps/redis-6fb5b985bc   1         1         1       2m21s\n\n")),(0,r.kt)("h4",{id:"namespace"},"namespace"),(0,r.kt)("p",null,"Download namespace related utilities.     "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"git clone https://github.com/ahmetb/kubectx  # Download kubectx packages.    \nsudo cp kubectx/kubensx /usr/local/bin\nsudo cp kubectx/kubens /usr/local/bin\n")),(0,r.kt)("p",null,"Namespace list    "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[junsulee@fedora kubernetes]$ kubens\ndefault\nkube-node-lease\nkube-public\nkube-system\nkubernetes-dashboard\n\n[junsulee@fedora kubernetes]$ kubectl get ns\nNAME                   STATUS   AGE\ndefault                Active   34d\nkube-node-lease        Active   34d\nkube-public            Active   34d\nkube-system            Active   34d\nkubernetes-dashboard   Active   33d\n")),(0,r.kt)("p",null,"Switching between namespaces"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'[junsulee@fedora kubernetes]$ kubens kube-system\nContext "minikube" modified.\nActive namespace is "kube-system".\n[junsulee@fedora kubernetes]$ kubectl get all\nNAME                                   READY   STATUS    RESTARTS   AGE\npod/coredns-74ff55c5b-qgdjv            1/1     Running   1          34d\npod/etcd-minikube                      1/1     Running   26         34d\npod/kube-apiserver-minikube            1/1     Running   60         34d\npod/kube-controller-manager-minikube   1/1     Running   3          34d\npod/kube-proxy-x48k4                   1/1     Running   1          34d\npod/kube-scheduler-minikube            1/1     Running   1          34d\npod/storage-provisioner                1/1     Running   107        34d\n\nNAME               TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE\nservice/kube-dns   ClusterIP   10.96.0.10   <none>        53/UDP,53/TCP,9153/TCP   34d\n\nNAME                        DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE\ndaemonset.apps/kube-proxy   1         1         1       1            1           kubernetes.io/os=linux   34d\n\nNAME                      READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/coredns   1/1     1            1           34d\n\nNAME                                DESIRED   CURRENT   READY   AGE\nreplicaset.apps/coredns-74ff55c5b   1         1         1       34d\n[junsulee@fedora kubernetes]$ kubens\ndefault\nkube-node-lease\nkube-public\nkube-system\nkubernetes-dashboard\n[junsulee@fedora kubernetes]$ kubens default\nContext "minikube" modified.\nActive namespace is "default".\n[junsulee@fedora kubernetes]$ kubectl get all\nNAME                             READY   STATUS    RESTARTS   AGE\npod/cmd-nginx-57bb5f6747-6clxd   1/1     Running   0          89m\npod/cmd-nginx-57bb5f6747-bgqz4   1/1     Running   0          21h\npod/redis-6fb5b985bc-6q7fk       1/1     Running   0          50m\n\nNAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE\nservice/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   34d\n\nNAME                        READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/cmd-nginx   1/1     1            1           21h\ndeployment.apps/redis       1/1     1            1           50m\n\nNAME                                   DESIRED   CURRENT   READY   AGE\nreplicaset.apps/cmd-nginx-57bb5f6747   1         1         1       21h\nreplicaset.apps/redis-6fb5b985bc       1         1         1       50m\n\n[junsulee@fedora kubernetes]$ cd\n[junsulee@fedora ~]$ cd .kube\n[junsulee@fedora .kube]$ cat config\napiVersion: v1\nclusters:\n- cluster:\n    certificate-authority: /home/junsulee/.minikube/ca.crt\n    extensions:\n    - extension:\n        last-update: Wed, 22 Jun 2022 12:12:20 AEST\n        provider: minikube.sigs.k8s.io\n        version: v1.20.0\n      name: cluster_info\n    server: https://192.168.39.25:8443\n  name: minikube\ncontexts:\n- context:\n    cluster: minikube\n    extensions:\n    - extension:\n        last-update: Wed, 22 Jun 2022 12:12:20 AEST\n        provider: minikube.sigs.k8s.io\n        version: v1.20.0\n      name: context_info\n    namespace: default\n    user: minikube\n  name: minikube\ncurrent-context: minikube\nkind: Config\npreferences: {}\nusers:\n- name: minikube\n  user:\n    client-certificate: /home/junsulee/.minikube/profiles/minikube/client.crt\n    client-key: /home/junsulee/.minikube/profiles/minikube/client.key\n\n')),(0,r.kt)("p",null,"Create a namespace and a pod on the namespace."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'\n[junsulee@fedora .kube]$ kubectl create ns myspace\nnamespace/myspace created\n\n[junsulee@fedora kubernetes]$ kubens\ndefault  <=== current\nkube-node-lease\nkube-public\nkube-system\nkubernetes-dashboard\nmyspace   <=== new\n\n[junsulee@fedora kubernetes]$ kubectl create -f busybox.yaml\npod/busybox2 created\n\n\n# expected error creating same name pod in the same namespace\n[junsulee@fedora kubernetes]$ kubectl create -f busybox.yaml\nError from server (AlreadyExists): error when creating "busybox.yaml": pods "busybox2" already exists\n\n[junsulee@fedora kubernetes]$ cp busybox.yaml busbox2.yaml\n\n# corrected namespace\n[junsulee@fedora kubernetes]$ cat busybox2.yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: busybox2\n  namespace: myspace\nspec:\n  containers:\n  - name: busy\n    image: busybox\n    command:\n      - sleep\n      - "3600"\n\n[junsulee@fedora kubernetes]$ kubectl create -f busybox2.yaml\npod/busybox2 created\n\n[junsulee@fedora kubernetes]$ kubectl get all -n myspace\nNAME           READY   STATUS    RESTARTS   AGE\npod/busybox2   1/1     Running   0          92s\n')),(0,r.kt)("h4",{id:"num-of-replicas"},"num of replicas"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'junsulee@fedora kubernetes]$ kubectl get deployments.apps\nNAME        READY   UP-TO-DATE   AVAILABLE   AGE\ncmd-nginx   1/1     1            1           22h\nredis       1/1     1            1           81m\n\n[junsulee@fedora kubernetes]$ kubectl edit deployment cmd-nginx\ndeployment.apps/cmd-nginx edited\n\n\n[junsulee@fedora kubernetes]$ kubectl get deployments.apps\nNAME        READY   UP-TO-DATE   AVAILABLE   AGE\ncmd-nginx   2/2     2            2           22h\nredis       1/1     1            1           86m\n\n[junsulee@fedora kubernetes]$ kubectl get deployments.apps\nNAME        READY   UP-TO-DATE   AVAILABLE   AGE\ncmd-nginx   2/2     2            2           22h\nredis       1/1     1            1           86m\n[junsulee@fedora kubernetes]$ kubectl scale --replicas=1 cmd-nginx\nerror: the server doesn\'t have a resource type "cmd-nginx"\n[junsulee@fedora kubernetes]$ kubectl scale --replicas=1 deployment cmd-nginx\ndeployment.apps/cmd-nginx scaled\n\n[junsulee@fedora kubernetes]$ kubectl get deployments.apps\nNAME        READY   UP-TO-DATE   AVAILABLE   AGE\ncmd-nginx   1/1     1            1           22h\nredis       1/1     1            1           102m\n')),(0,r.kt)("h4",{id:"managing-application-updates-and-rollbacks"},"Managing application updates and rollbacks"),(0,r.kt)("p",null,"Create a pod for test"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[junsulee@fedora kubernetes]$ kubectl create deployment rollingnginx --image=nginx:1.8\ndeployment.apps/rollingnginx created\n[junsulee@fedora kubernetes]$ kubectl get all\nNAME                                READY   STATUS      RESTARTS   AGE\n...\npod/rollingnginx-785db9758d-7k6zc   1/1     Running     0          62s\n...\n\n[junsulee@fedora kubernetes]$ kubectl rollout history deployment\ndeployment.apps/cmd-nginx\nREVISION  CHANGE-CAUSE\n1         <none>\n\ndeployment.apps/redis\nREVISION  CHANGE-CAUSE\n1         <none>\n\ndeployment.apps/rollingnginx\nREVISION  CHANGE-CAUSE\n1         <none>\n")),(0,r.kt)("p",null,"Edit version."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[junsulee@fedora kubernetes]$ kubectl edit deployments.apps rollingnginx\n..\n- image: nginx:1.8    <=== changed to 1.15\n..\n\n[junsulee@fedora kubernetes]$ kubectl rollout history deployment\ndeployment.apps/cmd-nginx\nREVISION  CHANGE-CAUSE\n1         <none>\n\ndeployment.apps/redis\nREVISION  CHANGE-CAUSE\n1         <none>\n\ndeployment.apps/rollingnginx\nREVISION  CHANGE-CAUSE\n1         <none>\n2         <none>     <======\n\n\n[junsulee@fedora kubernetes]$ kubectl describe deployments.apps rollingnginx\nName:                   rollingnginx\nNamespace:              default\nCreationTimestamp:      Sat, 25 Jun 2022 14:03:49 +1000\nLabels:                 app=rollingnginx\nAnnotations:            deployment.kubernetes.io/revision: 2    <====\nSelector:               app=rollingnginx\nReplicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable\nStrategyType:           RollingUpdate\nMinReadySeconds:        0\nRollingUpdateStrategy:  25% max unavailable, 25% max surge\nPod Template:\n  Labels:  app=rollingnginx\n  Containers:\n   nginx:\n    Image:        nginx:1.15\n    Port:         <none>\n    Host Port:    <none>\n    Environment:  <none>\n    Mounts:       <none>\n  Volumes:        <none>\nConditions:\n  Type           Status  Reason\n  ----           ------  ------\n  Available      True    MinimumReplicasAvailable\n  Progressing    True    NewReplicaSetAvailable\nOldReplicaSets:  <none>\nNewReplicaSet:   rollingnginx-58cff98f76 (1/1 replicas created)\nEvents:\n  Type    Reason             Age    From                   Message\n  ----    ------             ----   ----                   -------\n  Normal  ScalingReplicaSet  8m51s  deployment-controller  Scaled up replica set rollingnginx-785db9758d to 1\n  Normal  ScalingReplicaSet  104s   deployment-controller  Scaled up replica set rollingnginx-58cff98f76 to 1\n  Normal  ScalingReplicaSet  62s    deployment-controller  Scaled down replica set rollingnginx-785db9758d to 0\n\n\n[junsulee@fedora kubernetes]$ kubectl rollout history deployment rollingnginx --revision=1\ndeployment.apps/rollingnginx with revision #1\nPod Template:\n  Labels:   app=rollingnginx\n    pod-template-hash=785db9758d\n  Containers:\n   nginx:\n    Image:  nginx:1.8\n    Port:   <none>\n    Host Port:  <none>\n    Environment:    <none>\n    Mounts: <none>\n  Volumes:  <none>\n\n[junsulee@fedora kubernetes]$ kubectl rollout history deployment rollingnginx --revision=2\ndeployment.apps/rollingnginx with revision #2\nPod Template:\n  Labels:   app=rollingnginx\n    pod-template-hash=58cff98f76\n  Containers:\n   nginx:\n    Image:  nginx:1.15\n    Port:   <none>\n    Host Port:  <none>\n    Environment:    <none>\n    Mounts: <none>\n  Volumes:  <none>\n")),(0,r.kt)("p",null,"Two replica sets are shown. Old one will be gone eventually.   "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[junsulee@fedora kubernetes]$ kubectl get all\nNAME                                READY   STATUS    RESTARTS   AGE\npod/busybox2                        1/1     Running   1          72m\npod/cmd-nginx-57bb5f6747-6clxd      1/1     Running   0          173m\npod/cmd-nginx-57bb5f6747-bgqz4      1/1     Running   0          23h\npod/redis-6fb5b985bc-6q7fk          1/1     Running   0          134m\npod/rollingnginx-58cff98f76-997zw   1/1     Running   0          6m15s\n\nNAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE\nservice/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   34d\n\nNAME                           READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/cmd-nginx      1/1     1            1           23h\ndeployment.apps/redis          1/1     1            1           134m\ndeployment.apps/rollingnginx   1/1     1            1           13m\n\nNAME                                      DESIRED   CURRENT   READY   AGE\nreplicaset.apps/cmd-nginx-57bb5f6747      1         1         1       23h\nreplicaset.apps/redis-6fb5b985bc          1         1         1       134m\nreplicaset.apps/rollingnginx-58cff98f76   1         1         1       6m17s    <===\nreplicaset.apps/rollingnginx-785db9758d   0         0         0       13m      \n")),(0,r.kt)("p",null,"Rollback "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"junsulee@fedora kubernetes]$ kubectl rollout undo deployment rollingnginx --to-revision=1\ndeployment.apps/rollingnginx rolled back\n\n[junsulee@fedora kubernetes]$ kubectl get all\nNAME                                READY   STATUS    RESTARTS   AGE\npod/busybox2                        1/1     Running   1          76m\npod/cmd-nginx-57bb5f6747-6clxd      1/1     Running   0          177m\npod/cmd-nginx-57bb5f6747-bgqz4      1/1     Running   0          23h\npod/redis-6fb5b985bc-6q7fk          1/1     Running   0          138m\npod/rollingnginx-785db9758d-kzgd5   1/1     Running   0          79s\n\nNAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE\nservice/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   34d\n\nNAME                           READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/cmd-nginx      1/1     1            1           23h\ndeployment.apps/redis          1/1     1            1           138m\ndeployment.apps/rollingnginx   1/1     1            1           16m\n\nNAME                                      DESIRED   CURRENT   READY   AGE\nreplicaset.apps/cmd-nginx-57bb5f6747      1         1         1       23h\nreplicaset.apps/redis-6fb5b985bc          1         1         1       138m\nreplicaset.apps/rollingnginx-58cff98f76   0         0         0       9m45s\nreplicaset.apps/rollingnginx-785db9758d   1         1         1       16m   <====\n\n")))}d.isMDXComponent=!0}}]);